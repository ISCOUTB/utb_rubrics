name: Crear Release del Plugin Moodle UTB Rubrics

on:
  push:
    tags:
      - 'v*.*.*'  # Se activa con tags de versión como v1.0.0, v2.1.3, etc.

jobs:
  crear-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Obtener código fuente
      uses: actions/checkout@v3

    - name: Configurar PHP 8.1
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: zip, curl, mbstring

    - name: Obtener versión del tag
      id: get_version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "VERSION_NUMBER=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Actualizar version.php con la versión del tag
      run: |
        VERSION_NUMBER="${{ steps.get_version.outputs.VERSION_NUMBER }}"
        # Convertir versión como "1.2.3" al formato Moodle "2025092800"
        # Por seguridad, usamos timestamp actual
        TIMESTAMP=$(date +%Y%m%d%H)
        
        # Actualizar version.php con la versión de release
        sed -i "s/\$plugin->release\s*=\s*'[^']*'/\$plugin->release = '$VERSION_NUMBER'/" version.php
        sed -i "s/\$plugin->version\s*=\s*[0-9]*/\$plugin->version = $TIMESTAMP/" version.php
        
        echo "version.php actualizado:"
        echo "- Release: $VERSION_NUMBER"
        echo "- Versión: $TIMESTAMP"

    - name: Validar estructura del plugin
      run: |
        echo "Validando estructura del plugin..."
        
        # Verificar archivos requeridos
        required_files=(
          "version.php"
          "lib.php" 
          "renderer.php"
          "db/install.xml"
          "db/install.php"
          "db/upgrade.php"
          "lang/en/gradingform_utbrubrics.php"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Archivo requerido faltante: $file"
            exit 1
          fi
          echo "✅ Encontrado: $file"
        done

        # Validar sintaxis PHP
        echo "Verificando sintaxis PHP..."
        find . -name "*.php" -exec php -l {} \; || exit 1
        
        echo "✅ Validación de estructura del plugin exitosa"

    - name: Crear ZIP del plugin
      run: |
        echo "Creando paquete ZIP del plugin Moodle..."
        
        # Crear directorio temporal
        TEMP_DIR="temp_package"
        PLUGIN_DIR="$TEMP_DIR/utbrubrics"
        
        mkdir -p "$PLUGIN_DIR"
        mkdir -p "$PLUGIN_DIR/db"
        mkdir -p "$PLUGIN_DIR/lang/en"
        mkdir -p "$PLUGIN_DIR/lang/es"
        mkdir -p "$PLUGIN_DIR/tests"
        
        echo "📋 Copiando archivos del plugin con estructura correcta..."
        
        # Copiar archivos principales
        MAIN_FILES=(
          "version.php"
          "lib.php"
          "edit.php"
          "renderer.php"
          "README.md"
        )
        
        for file in "${MAIN_FILES[@]}"; do
          if [ -e "$file" ]; then
            cp "$file" "$PLUGIN_DIR/"
            echo "✅ Copiado: $file"
          else
            echo "⚠️  No encontrado: $file"
          fi
        done
        
        # Copiar archivos de base de datos manteniendo estructura
        if [ -d "db" ]; then
          cp db/* "$PLUGIN_DIR/db/" 2>/dev/null || true
          echo "✅ Copiado: db/$(ls db | wc -l) archivos"
        fi
        
        # Copiar archivos de idioma manteniendo estructura
        if [ -d "lang/en" ]; then
          cp lang/en/* "$PLUGIN_DIR/lang/en/" 2>/dev/null || true
          echo "✅ Copiado: lang/en/$(ls lang/en | wc -l) archivos"
        fi
        
        if [ -d "lang/es" ]; then
          cp lang/es/* "$PLUGIN_DIR/lang/es/" 2>/dev/null || true
          echo "✅ Copiado: lang/es/$(ls lang/es | wc -l) archivos"
        fi
        
        # Copiar archivos de prueba (opcional)
        if [ -d "tests" ]; then
          cp tests/* "$PLUGIN_DIR/tests/" 2>/dev/null || true
          echo "✅ Copiado: tests/$(ls tests | wc -l) archivos"
        fi
        
        # Mostrar estructura final
        echo ""
        echo "📂 Estructura final del paquete:"
        find "$TEMP_DIR" -type f | sort
        
        # Crear el archivo ZIP
        echo ""
        echo "📦 Creando archivo ZIP..."
        cd "$TEMP_DIR"
        zip -r "../moodle-gradingform_utbrubrics-${{ steps.get_version.outputs.VERSION_NUMBER }}.zip" . -q
        cd ..
        
        # Verificar contenidos del ZIP
        echo ""
        echo "📋 Contenidos del ZIP:"
        unzip -l "moodle-gradingform_utbrubrics-${{ steps.get_version.outputs.VERSION_NUMBER }}.zip"
        
        # Limpiar directorio temporal
        rm -rf "$TEMP_DIR"
        
        echo ""
        echo "✅ ZIP del plugin creado exitosamente"

    - name: Probar estructura de instalación del ZIP
      run: |
        echo "🔍 Probando estructura de instalación del ZIP..."
        
        # Crear directorio de prueba
        mkdir -p test_install
        cd test_install
        
        # Extraer ZIP
        unzip -q "../moodle-gradingform_utbrubrics-${{ steps.get_version.outputs.VERSION_NUMBER }}.zip"
        
        echo "📂 Estructura extraída:"
        find . -type f | head -20
        
        # Verificar estructura
        PLUGIN_PATH="utbrubrics"
        
        echo "📂 Estructura extraída:"
        find . -type f | head -20
        
        if [ ! -d "$PLUGIN_PATH" ]; then
          echo "❌ ERROR: Estructura incorrecta del ZIP - directorio $PLUGIN_PATH no encontrado"
          echo "Estructura actual:"
          find . -type d
          exit 1
        fi
        
        # Verificar archivos críticos
        CRITICAL_FILES=(
          "$PLUGIN_PATH/version.php"
          "$PLUGIN_PATH/lib.php" 
          "$PLUGIN_PATH/db/install.xml"
          "$PLUGIN_PATH/lang/en/gradingform_utbrubrics.php"
        )
        
        echo "🔍 Verificando archivos críticos..."
        
        for file in "${CRITICAL_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ ERROR: Archivo crítico faltante: $file"
            exit 1
          fi
          echo "✅ Verificado: $file"
        done
        
        # Verificar si version.php tiene el componente correcto
        if ! grep -q "gradingform_utbrubrics" "$PLUGIN_PATH/version.php"; then
          echo "❌ ERROR: version.php no contiene el componente correcto"
          cat "$PLUGIN_PATH/version.php"
          exit 1
        fi
        
        # Extraer y mostrar información del plugin
        COMPONENT=$(grep "component" "$PLUGIN_PATH/version.php" | grep -o "'[^']*'" | sed "s/'//g")
        RELEASE=$(grep "release" "$PLUGIN_PATH/version.php" | grep -o "'[^']*'" | sed "s/'//g")
        
        echo ""
        echo "📊 Información del plugin verificada:"
        echo "   🏷️  Componente: $COMPONENT"
        echo "   🚀 Release: $RELEASE"
        echo "   📁 Ubicación: /grade/grading/form/utbrubrics/"
        
        echo ""
        echo "✅ Prueba de estructura del ZIP exitosa - Listo para Moodle"
        cd ..

    - name: Generar notas de release
      id: release_notes
      run: |
        set -euo pipefail

        VERSION_NUMBER="${{ steps.get_version.outputs.VERSION_NUMBER }}"
        TAG="${{ steps.get_version.outputs.VERSION }}"
        ZIPNAME="moodle-gradingform_utbrubrics-${VERSION_NUMBER}.zip"

        CHANGELOG_SECTION=""

        if [ -f CHANGELOG.md ]; then
          CHANGELOG_SECTION=$(awk -v ver="${VERSION_NUMBER}" '
            /^## \[/{
              if(in_section) exit
              if(index($0, "[" ver "]")) {
                in_section=1
                sub(/^##[[:space:]]*/, "", $0)
                print $0
                next
              }
            }
            in_section { print }
          ' CHANGELOG.md || true)
        fi

        if [ -z "$CHANGELOG_SECTION" ]; then
          git fetch --tags --quiet || true
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${TAG}$" | head -n1 || true)
          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..$TAG"
          else
            RANGE="$TAG"
          fi
          CHANGELOG_SECTION=$(git --no-pager log --pretty=format:"- %h %s (%an)" "$RANGE" || true)
        fi

        if [ -z "$CHANGELOG_SECTION" ]; then
          CHANGELOG_SECTION="- (sin cambios registrados)"
        fi

        {
          echo "# Plugin UTB Rubrics Versión ${VERSION_NUMBER}"
          echo ""
          echo "## Cambios en esta versión"
          printf "%s\n" "$CHANGELOG_SECTION"
          echo ""
          echo "## Instalación"
          echo "1. Descarga:"
          echo "   - ${ZIPNAME}"
          echo "2. Inicia sesión en tu sitio Moodle como administrador"
          echo "3. Navega a: Administración del sitio > Plugins > Instalar plugins"
          echo "4. Sube el archivo ZIP"
          echo "5. Tipo de extensión: Selecciona \"Método de calificación avanzado\""
          echo "6. Haz clic en \"Instalar plugin desde archivo ZIP\""
          echo "7. Sigue las instrucciones de instalación"
          echo ""
          echo "## Requisitos"
          echo "- Moodle: 4.0 o superior"
          echo "- PHP: 7.4 a 8.2"
          echo "- Base de datos: MySQL 5.7+, PostgreSQL 10+, o MariaDB 10.3+"
          echo ""
          echo "## Soporte"
          echo "Si encuentras algún problema, por favor repórtalo en nuestra página de GitHub Issues: https://github.com/${{ github.repository }}/issues"
          echo ""
          echo "Paquete de instalación: Este archivo ZIP contiene el plugin completo con la estructura de directorio correcta para el sistema de instalación automática de Moodle."
        } > release_notes.md

    - name: Crear Release en GitHub
      uses: softprops/action-gh-release@v1
      with:
        files: |
          moodle-gradingform_utbrubrics-${{ steps.get_version.outputs.VERSION_NUMBER }}.zip
        body_path: release_notes.md
        name: "UTB Rubrics v${{ steps.get_version.outputs.VERSION_NUMBER }}"
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Validar Release
      run: |
        echo "🎉 ¡Release creado exitosamente!"
        echo ""
        echo "Detalles del Release:"
        echo "- Versión: ${{ steps.get_version.outputs.VERSION_NUMBER }}"
        echo "- Tag: ${{ steps.get_version.outputs.VERSION }}"
        echo "- Archivo: moodle-gradingform_utbrubrics-${{ steps.get_version.outputs.VERSION_NUMBER }}.zip"
        echo "- Tamaño: $(du -h moodle-gradingform_utbrubrics-${{ steps.get_version.outputs.VERSION_NUMBER }}.zip | cut -f1)"
        echo "- Estado: LATEST (último)"
        echo ""
        echo "🚀 Instalación:"
        echo "📦 Archivo: moodle-gradingform_utbrubrics-${{ steps.get_version.outputs.VERSION_NUMBER }}.zip"
        echo "   - Sube el archivo en Moodle"
        echo "   - Selecciona: 'Método de calificación avanzado'"
        echo "   - Sigue las instrucciones de instalación"
        echo ""
        echo "✅ ¡Listo para instalación en Moodle!"